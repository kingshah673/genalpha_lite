{% extends "layouts/base.html" %}

{% block title %}{{ product.name }} - GenAlpha{% endblock %}

{% block content %}
<div class="bg-white">
    <div class="container-custom py-16 sm:py-24">
        
        <!-- Breadcrumb -->
        <nav aria-label="Breadcrumb" class="mb-8">
            <ol role="list" class="flex items-center space-x-2 text-sm text-gray-500">
                <li><a href="/" class="hover:text-gray-900">Home</a></li>
                <li>
                    <svg class="h-5 w-5 text-gray-300" fill="currentColor" viewBox="0 0 20 20" aria-hidden="true">
                        <path d="M5.555 17.776l8-16 .894.448-8 16-.894-.448z" />
                    </svg>
                </li>
                <li><a href="{% url 'products:shop' %}" class="hover:text-gray-900">Shop</a></li>
                <li>
                    <svg class="h-5 w-5 text-gray-300" fill="currentColor" viewBox="0 0 20 20" aria-hidden="true">
                        <path d="M5.555 17.776l8-16 .894.448-8 16-.894-.448z" />
                    </svg>
                </li>
                <li><a href="{% url 'products:category' product.category.slug %}" class="hover:text-gray-900">{{ product.category.name }}</a></li>
                <li>
                    <svg class="h-5 w-5 text-gray-300" fill="currentColor" viewBox="0 0 20 20" aria-hidden="true">
                        <path d="M5.555 17.776l8-16 .894.448-8 16-.894-.448z" />
                    </svg>
                </li>
                <li class="font-medium text-gray-900">{{ product.name }}</li>
            </ol>
        </nav>

        <div class="lg:grid lg:grid-cols-2 lg:gap-x-16 lg:items-start">
            <!-- Image Gallery -->
            <div class="flex flex-col-reverse" x-data="{ activeImage: '{{ product.primary_image.image.url }}' }">
                <!-- Image selector -->
                <div class="mx-auto mt-6 hidden w-full max-w-2xl sm:block lg:max-w-none">
                    <div class="grid grid-cols-4 gap-6" aria-orientation="horizontal" role="tablist">
                        {% for img in product.images.all %}
                        <button @click="activeImage = '{{ img.image.url }}'" 
                                class="relative flex h-24 cursor-pointer items-center justify-center rounded-md bg-white text-sm font-medium uppercase text-gray-900 hover:bg-gray-50 focus:outline-none focus:ring focus:ring-opacity-50 focus:ring-offset-4" 
                                :class="activeImage === '{{ img.image.url }}' ? 'ring-2 ring-primary-500' : 'ring-transparent'">
                            <span class="sr-only">Image {{ forloop.counter }}</span>
                            <span class="absolute inset-0 overflow-hidden rounded-md">
                                <img src="{{ img.image.url }}" alt="{{ img.alt_text }}" class="h-full w-full object-cover object-center">
                            </span>
                        </button>
                        {% endfor %}
                    </div>
                </div>

                <div class="aspect-h-1 aspect-w-1 w-full overflow-hidden rounded-lg bg-gray-100">
                    <img :src="activeImage" alt="{{ product.name }}" class="h-full w-full object-cover object-center sm:rounded-lg">
                </div>
            </div>

            <!-- Product Info -->
            <div class="mt-10 px-4 sm:px-0 sm:mt-16 lg:mt-0">
                <h1 class="text-3xl font-bold tracking-tight text-gray-900">{{ product.name }}</h1>
                
                <div class="mt-3">
                    <h2 class="sr-only">Product information</h2>
                    <p class="text-3xl tracking-tight text-gray-900">${{ product.base_price }}</p>
                </div>

                <div class="mt-6">
                    <h3 class="sr-only">Description</h3>
                    <div class="text-base text-gray-700 space-y-6">
                        {{ product.description|linebreaks }}
                    </div>
                </div>

                <form class="mt-6" 
                      x-data="{ 
                        productId: '{{ product.id }}',
                        validCombinations: {{ valid_combinations|safe }},
                        selectedColor: '',
                        selectedSize: '',
                        isSizeAvailable(size) {
                            if (!this.selectedColor) return true;
                            return this.validCombinations.some(c => c.color === this.selectedColor && c.size === size);
                        },
                        isColorAvailable(color) {
                            return this.validCombinations.some(c => c.color === color);
                        }
                      }"
                      hx-post="/cart/add/" 
                      hx-target="#cart-drawer-content" 
                      hx-swap="innerHTML" 
                      @htmx:after-request="$dispatch('toggle-cart'); $dispatch('cartUpdated')">
                    {% csrf_token %}
                    <input type="hidden" name="product_id" :value="productId">
                    
                    <!-- Colors -->
                    {% if colors %}
                    <div class="mt-8">
                        <h3 class="text-sm font-medium text-gray-900 flex justify-between">
                            <span>Color</span>
                            <span class="text-primary-600 font-semibold" x-text="selectedColor"></span>
                        </h3>
                        <div class="mt-2 flex items-center space-x-3">
                            {% for color in colors %}
                            <label class="relative -m-0.5 flex cursor-pointer items-center justify-center rounded-full p-0.5 focus:outline-none ring-gray-400">
                                <input type="radio" name="color" value="{{ color }}" required class="sr-only peer" @change="selectedColor = '{{ color }}'; if(!isSizeAvailable(selectedSize)) selectedSize = ''">
                                <span class="h-8 w-8 rounded-full border border-gray-200 border-opacity-10 bg-gray-100 flex items-center justify-center text-xs overflow-hidden transition-all" 
                                      :class="{
                                        'ring-2 ring-offset-2 ring-primary-600': selectedColor === '{{ color }}',
                                        'opacity-25 grayscale cursor-not-allowed': !isColorAvailable('{{ color }}')
                                      }">
                                    {{ color }}
                                </span>
                            </label>
                            {% endfor %}
                        </div>
                    </div>
                    {% endif %}

                    <!-- Sizes -->
                    {% if sizes %}
                    <div class="mt-8">
                        <div class="flex items-center justify-between">
                            <h3 class="text-sm font-medium text-gray-900">
                                <span>Size</span>
                                <span class="ml-2 text-primary-600 font-semibold" x-text="selectedSize"></span>
                            </h3>
                        </div>

                        <div class="mt-2 grid grid-cols-4 gap-4 sm:grid-cols-8 lg:grid-cols-4">
                            {% for size in sizes %}
                            <label class="group relative flex items-center justify-center rounded-md border py-3 px-4 text-sm font-medium uppercase transition-all sm:flex-1 cursor-pointer"
                                   :class="{
                                     'bg-white text-gray-900 shadow-sm hover:bg-gray-50': isSizeAvailable('{{ size }}'),
                                     'bg-gray-50 text-gray-400 cursor-not-allowed opacity-50': !isSizeAvailable('{{ size }}')
                                   }">
                                <input type="radio" 
                                       name="size" 
                                       value="{{ size }}" 
                                       required 
                                       class="sr-only" 
                                       :disabled="!isSizeAvailable('{{ size }}')"
                                       @change="selectedSize = '{{ size }}'">
                                <span class="absolute inset-0 rounded-md ring-2 ring-transparent pointer-events-none transition-all" 
                                      :class="{
                                        '!ring-primary-600': selectedSize === '{{ size }}',
                                        'group-hover:ring-gray-300': isSizeAvailable('{{ size }}')
                                      }"></span>
                                <span id="size-choice-{{ size }}-label">{{ size }}</span>
                            </label>
                            {% endfor %}
                        </div>
                        <div x-show="selectedColor && !selectedSize" class="mt-2 text-xs text-primary-600 italic animate-pulse">
                            Please select an available size for this color.
                        </div>
                    </div>
                    {% endif %}
                    
                    <!-- Quantity -->
                    <div class="mt-8">
                         <h3 class="text-sm font-medium text-gray-900">Quantity</h3>
                         <div class="mt-2 flex items-center border border-gray-300 rounded-md w-32" x-data="{ qty: 1 }">
                             <button type="button" class="px-3 py-2 text-gray-600 hover:bg-gray-100 bg-white rounded-l-md" @click="if(qty > 1) qty--">-</button>
                             <input type="number" name="quantity" x-model="qty" min="1" class="w-full text-center border-none p-0 focus:ring-0 text-gray-900 font-semibold" readonly>
                             <button type="button" class="px-3 py-2 text-gray-600 hover:bg-gray-100 bg-white rounded-r-md" @click="qty++">+</button>
                         </div>
                    </div>

                    <div class="mt-10 flex">
                        <button type="submit" 
                                :disabled="!selectedColor || !selectedSize"
                                :class="{'opacity-50 cursor-not-allowed': !selectedColor || !selectedSize}"
                                class="flex max-w-xs flex-1 items-center justify-center rounded-md border border-transparent bg-black px-8 py-3 text-base font-medium text-white hover:bg-gray-800 transition-all focus:outline-none focus:ring-2 focus:ring-primary-500 focus:ring-offset-2 sm:w-full">
                            {% if product.in_stock %}Add to cart{% else %}Out of Stock{% endif %}
                        </button>
                    </div>
                </form>
            </div>
        </div>
        
        <!-- Related Products -->
        <div class="mt-24 border-t border-gray-200 pt-16">
            <h2 class="text-2xl font-bold tracking-tight text-gray-900 mb-8">You may also like</h2>
            <div class="grid grid-cols-1 md:grid-cols-4 gap-8">
                {% for related in related_products %}
                    {% include "components/product_card.html" with product=related %}
                {% endfor %}
            </div>
        </div>
    </div>
</div>
{% endblock %}
